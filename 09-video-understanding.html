<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecture Recording Summariser ‚Äî Gemini AI</title>
    <style>
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --navy: #0f2044;
            --navy-mid: #1a3260;
            --navy-light: #243f7a;
            --slate: #4a5568;
            --slate-light: #718096;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --accent-light: #dbeafe;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --bg: #f0f4f8;
            --surface: #ffffff;
            --border: #cbd5e1;
            --text: #1e293b;
            --text-muted: #64748b;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            min-height: 100vh;
            color: var(--text);
        }

        /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
        .header {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-mid) 60%, var(--navy-light) 100%);
            color: white;
            padding: 32px 24px 28px;
            text-align: center;
        }

        .header-badge {
            display: inline-block;
            background: rgba(59,130,246,0.25);
            border: 1px solid rgba(59,130,246,0.4);
            color: #93c5fd;
            font-size: 0.72rem;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            padding: 4px 12px;
            border-radius: 20px;
            margin-bottom: 14px;
        }

        .header h1 {
            font-size: 2.1rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: 8px;
        }

        .header p {
            color: #94a3b8;
            font-size: 1rem;
            max-width: 520px;
            margin: 0 auto;
            line-height: 1.5;
        }

        /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
        .main {
            max-width: 960px;
            margin: 0 auto;
            padding: 24px 16px 48px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: var(--surface);
            border-radius: 14px;
            border: 1px solid var(--border);
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
            overflow: hidden;
        }

        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-header h2 {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--navy);
        }

        .card-icon {
            width: 30px;
            height: 30px;
            background: var(--accent-light);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .card-body {
            padding: 20px;
        }

        /* ‚îÄ‚îÄ API Key ‚îÄ‚îÄ */
        .api-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .api-row input {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            font-family: monospace;
            transition: border-color 0.2s;
            color: var(--text);
        }

        .api-row input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn-save {
            padding: 10px 20px;
            background: var(--navy);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            white-space: nowrap;
            transition: background 0.2s;
        }

        .btn-save:hover { background: var(--navy-light); }

        .api-status {
            margin-top: 8px;
            font-size: 0.82rem;
            color: var(--text-muted);
        }

        .api-status.ok { color: var(--success); font-weight: 500; }
        .api-status.err { color: var(--danger); font-weight: 500; }

        /* ‚îÄ‚îÄ Upload Section ‚îÄ‚îÄ */
        .tabs {
            display: flex;
            gap: 0;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.88rem;
            font-weight: 500;
            color: var(--text-muted);
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: var(--navy);
            color: white;
        }

        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* File drop zone */
        .dropzone {
            border: 2px dashed var(--border);
            border-radius: 10px;
            padding: 36px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #fafbff;
        }

        .dropzone:hover, .dropzone.over {
            border-color: var(--accent);
            background: var(--accent-light);
        }

        .dropzone-icon { font-size: 2.4rem; margin-bottom: 10px; }
        .dropzone h3 { font-size: 1rem; font-weight: 600; color: var(--navy); margin-bottom: 4px; }
        .dropzone p { font-size: 0.85rem; color: var(--text-muted); }

        .btn-browse {
            display: inline-block;
            margin-top: 12px;
            padding: 9px 18px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 7px;
            cursor: pointer;
            font-size: 0.88rem;
            font-weight: 500;
            transition: background 0.2s;
        }

        .btn-browse:hover { background: var(--accent-hover); }

        #fileInput { display: none; }

        .video-preview {
            width: 100%;
            max-height: 260px;
            border-radius: 8px;
            margin-top: 12px;
            display: none;
            background: #000;
        }

        .file-info {
            display: none;
            margin-top: 10px;
            padding: 10px 14px;
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 7px;
            font-size: 0.85rem;
            color: var(--success);
        }

        /* URL tab */
        .url-row {
            display: flex;
            gap: 8px;
        }

        .url-row input {
            flex: 1;
            padding: 11px 14px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }

        .url-row input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn-load {
            padding: 11px 18px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.88rem;
            font-weight: 500;
            white-space: nowrap;
            transition: background 0.2s;
        }

        .btn-load:hover { background: var(--accent-hover); }

        .url-hint {
            margin-top: 8px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .url-loaded {
            display: none;
            margin-top: 10px;
            padding: 10px 14px;
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 7px;
            font-size: 0.85rem;
            color: var(--success);
            word-break: break-all;
        }

        /* ‚îÄ‚îÄ Quick Actions ‚îÄ‚îÄ */
        .actions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .action-btn {
            padding: 13px 16px;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-family: inherit;
        }

        .action-btn:hover:not(:disabled) {
            border-color: var(--accent);
            background: var(--accent-light);
        }

        .action-btn:disabled {
            opacity: 0.45;
            cursor: not-allowed;
        }

        .action-btn.full-width {
            grid-column: 1 / -1;
        }

        .action-icon { font-size: 1.3rem; flex-shrink: 0; margin-top: 1px; }

        .action-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .action-title {
            font-size: 0.88rem;
            font-weight: 600;
            color: var(--navy);
        }

        .action-desc {
            font-size: 0.77rem;
            color: var(--text-muted);
            line-height: 1.4;
        }

        /* ‚îÄ‚îÄ Custom prompt ‚îÄ‚îÄ */
        .custom-row {
            display: flex;
            gap: 8px;
        }

        .custom-row textarea {
            flex: 1;
            padding: 11px 14px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            font-family: inherit;
            resize: vertical;
            min-height: 72px;
            transition: border-color 0.2s;
            color: var(--text);
        }

        .custom-row textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn-ask {
            align-self: flex-end;
            padding: 11px 20px;
            background: var(--navy);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background 0.2s;
            white-space: nowrap;
        }

        .btn-ask:hover { background: var(--navy-light); }
        .btn-ask:disabled { opacity: 0.45; cursor: not-allowed; }

        /* ‚îÄ‚îÄ Output ‚îÄ‚îÄ */
        .output-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .output-label {
            font-size: 0.82rem;
            color: var(--text-muted);
            font-style: italic;
        }

        .output-area {
            min-height: 220px;
            padding: 18px;
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 0.9rem;
            line-height: 1.7;
            color: var(--text);
            white-space: pre-wrap;
            word-break: break-word;
        }

        .output-placeholder {
            color: var(--text-muted);
            font-style: italic;
        }

        /* Processing states */
        .status-bar {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--accent-hover);
            margin-bottom: 12px;
        }

        .status-bar.active { display: flex; }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #bfdbfe;
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            flex-shrink: 0;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Copy btn */
        .btn-copy {
            padding: 6px 12px;
            background: none;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            color: var(--text-muted);
            transition: all 0.2s;
            display: none;
        }

        .btn-copy:hover { background: var(--bg); color: var(--text); }
        .btn-copy.visible { display: inline-block; }

        /* Markdown-style formatting in output */
        .output-area h2 {
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--navy);
            margin: 16px 0 6px;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--border);
        }

        .output-area h3 {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--navy-mid);
            margin: 12px 0 4px;
        }

        .output-area strong { color: var(--navy); }

        .output-area .ts-badge {
            display: inline-block;
            background: var(--navy);
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            padding: 2px 7px;
            border-radius: 4px;
            margin-right: 6px;
            font-family: monospace;
        }

        .output-area .concept-tag {
            display: inline-block;
            background: var(--accent-light);
            color: var(--accent-hover);
            font-size: 0.78rem;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 12px;
            margin: 2px;
        }

        .output-area .deadline-tag {
            display: inline-block;
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
            font-size: 0.8rem;
            font-weight: 600;
            padding: 3px 10px;
            border-radius: 6px;
            margin: 2px;
        }

        /* ‚îÄ‚îÄ Upload progress ‚îÄ‚îÄ */
        .progress-wrap {
            display: none;
            margin-top: 10px;
        }

        .progress-wrap.visible { display: block; }

        .progress-bar {
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 2px;
            transition: width 0.3s;
            width: 0%;
        }

        .progress-label {
            margin-top: 5px;
            font-size: 0.78rem;
            color: var(--text-muted);
        }

        /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
        @media (max-width: 640px) {
            .header h1 { font-size: 1.5rem; }
            .actions-grid { grid-template-columns: 1fr; }
            .action-btn.full-width { grid-column: 1; }
            .api-row { flex-direction: column; }
            .btn-save { width: 100%; }
            .url-row { flex-direction: column; }
            .custom-row { flex-direction: column; }
            .btn-ask { width: 100%; }
        }
    </style>
</head>
<body>

<div class="header">
    <div class="header-badge">Gemini Video AI ¬∑ Demo 09</div>
    <h1>üìö Lecture Recording Summariser</h1>
    <p>Upload a lecture recording or paste a YouTube link ‚Äî Gemini analyses the content and generates study materials instantly.</p>
</div>

<div class="main">

    <!-- API Key -->
    <div class="card">
        <div class="card-header">
            <div class="card-icon">üîë</div>
            <h2>Google AI API Key</h2>
        </div>
        <div class="card-body">
            <div class="api-row">
                <input type="password" id="apiKeyInput" placeholder="AIza‚Ä¶" autocomplete="off">
                <button class="btn-save" id="saveApiKey">Save</button>
            </div>
            <div class="api-status" id="apiStatus">Enter your Google AI API key from <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:var(--accent)">Google AI Studio</a> to get started.</div>
        </div>
    </div>

    <!-- Video Input -->
    <div class="card">
        <div class="card-header">
            <div class="card-icon">üé¨</div>
            <h2>Lecture Video</h2>
        </div>
        <div class="card-body">
            <div class="tabs">
                <button class="tab-btn active" data-tab="upload">Upload File</button>
                <button class="tab-btn" data-tab="url">YouTube / URL</button>
            </div>

            <!-- File upload tab -->
            <div class="tab-panel active" id="tab-upload">
                <div class="dropzone" id="dropzone" onclick="document.getElementById('fileInput').click()">
                    <div class="dropzone-icon">üéûÔ∏è</div>
                    <h3>Drop your lecture recording here</h3>
                    <p>Supports MP4, WebM, MOV, AVI, MKV ¬∑ Up to 2 GB</p>
                    <button class="btn-browse" onclick="event.stopPropagation(); document.getElementById('fileInput').click()">Browse files</button>
                    <input type="file" id="fileInput" accept="video/*">
                </div>
                <div class="progress-wrap" id="uploadProgress">
                    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                    <div class="progress-label" id="progressLabel">Uploading to Files API‚Ä¶</div>
                </div>
                <div class="file-info" id="fileInfo"></div>
                <video id="videoPreview" class="video-preview" controls></video>
            </div>

            <!-- URL tab -->
            <div class="tab-panel" id="tab-url">
                <div class="url-row">
                    <input type="url" id="videoUrl" placeholder="https://www.youtube.com/watch?v=‚Ä¶">
                    <button class="btn-load" onclick="loadVideoUrl()">Load</button>
                </div>
                <p class="url-hint">Gemini supports YouTube links and other public video URLs.</p>
                <div class="url-loaded" id="urlLoaded"></div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card">
        <div class="card-header">
            <div class="card-icon">‚ö°</div>
            <h2>Quick Actions</h2>
        </div>
        <div class="card-body">
            <div class="actions-grid" id="actionsGrid">
                <button class="action-btn" disabled data-prompt="timestamps" onclick="runAction(this)">
                    <span class="action-icon">üïê</span>
                    <span class="action-text">
                        <span class="action-title">Summarise with timestamps</span>
                        <span class="action-desc">Topic-by-topic breakdown with time markers</span>
                    </span>
                </button>
                <button class="action-btn" disabled data-prompt="concepts" onclick="runAction(this)">
                    <span class="action-icon">üìñ</span>
                    <span class="action-text">
                        <span class="action-title">Extract key concepts &amp; definitions</span>
                        <span class="action-desc">Glossary of terms, theories, and models</span>
                    </span>
                </button>
                <button class="action-btn" disabled data-prompt="assessment" onclick="runAction(this)">
                    <span class="action-icon">üìÖ</span>
                    <span class="action-text">
                        <span class="action-title">Find due dates &amp; exam info</span>
                        <span class="action-desc">Any mentioned assessments, deadlines, exams</span>
                    </span>
                </button>
                <button class="action-btn" disabled data-prompt="questions" onclick="runAction(this)">
                    <span class="action-icon">‚ùì</span>
                    <span class="action-text">
                        <span class="action-title">Generate study questions</span>
                        <span class="action-desc">Practice questions based on lecture content</span>
                    </span>
                </button>
                <button class="action-btn full-width" disabled data-prompt="studyguide" onclick="runAction(this)">
                    <span class="action-icon">‚ö°</span>
                    <span class="action-text">
                        <span class="action-title">Give me a 5-minute study guide for this lecture</span>
                        <span class="action-desc">Everything you need to know ‚Äî fast</span>
                    </span>
                </button>
            </div>

            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                <div style="font-size: 0.85rem; font-weight: 600; color: var(--navy); margin-bottom: 8px;">Or ask something specific</div>
                <div class="custom-row">
                    <textarea id="customPrompt" placeholder="e.g. What did the lecturer say about the assignment? Summarise the tutorial content for Week 5‚Ä¶" disabled></textarea>
                    <button class="btn-ask" id="askBtn" disabled onclick="runCustom()">Ask Gemini</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Output -->
    <div class="card">
        <div class="card-header">
            <div class="output-header" style="width:100%; display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <div class="card-icon">üìù</div>
                    <h2>Analysis Output</h2>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <span class="output-label" id="outputLabel"></span>
                    <button class="btn-copy" id="copyBtn" onclick="copyOutput()">Copy</button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="status-bar" id="statusBar">
                <div class="spinner"></div>
                <span id="statusText">Analysing lecture‚Ä¶</span>
            </div>
            <div class="output-area" id="outputArea">
                <span class="output-placeholder">Your analysis will appear here. Select a quick action above or ask a custom question once you've loaded a lecture video.</span>
            </div>
        </div>
    </div>

</div><!-- /main -->

<script type="module">
import { GoogleGenAI } from "https://esm.sh/@google/genai@latest";

// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let apiKey = localStorage.getItem('googleAiApiKey') || '';
let ai = null;
let uploadedFileUri = null;   // URI from Files API after upload + ACTIVE
let uploadedFileMime = null;
let youtubeUrl = null;
let isProcessing = false;

// ‚îÄ‚îÄ Elements ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const apiKeyInput   = document.getElementById('apiKeyInput');
const saveApiKeyBtn = document.getElementById('saveApiKey');
const apiStatus     = document.getElementById('apiStatus');
const fileInput     = document.getElementById('fileInput');
const dropzone      = document.getElementById('dropzone');
const videoPreview  = document.getElementById('videoPreview');
const fileInfo      = document.getElementById('fileInfo');
const uploadProgress = document.getElementById('uploadProgress');
const progressFill  = document.getElementById('progressFill');
const progressLabel = document.getElementById('progressLabel');
const videoUrlInput = document.getElementById('videoUrl');
const urlLoaded     = document.getElementById('urlLoaded');
const actionsGrid   = document.getElementById('actionsGrid');
const customPrompt  = document.getElementById('customPrompt');
const askBtn        = document.getElementById('askBtn');
const statusBar     = document.getElementById('statusBar');
const statusText    = document.getElementById('statusText');
const outputArea    = document.getElementById('outputArea');
const outputLabel   = document.getElementById('outputLabel');
const copyBtn       = document.getElementById('copyBtn');

// ‚îÄ‚îÄ Prompt templates ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PROMPTS = {
    timestamps: `You are a study assistant helping an Australian university student.
Analyse this lecture recording and produce a **timestamped summary** of the topics covered.

Format your response exactly like this:
- Use [MM:SS] or [H:MM:SS] timestamps at the start of each entry
- Group related content under clear section headings
- Keep each entry to 1‚Äì2 sentences describing what the lecturer explains at that point
- Use Australian university terminology: "unit" (not course), "tutorial" (not recitation/section), "lecturer" (not professor), "assessment" (not assignment where general), "marking guide" (not rubric)

Start with a brief 2-sentence overview of the entire lecture, then give the timestamped breakdown.`,

    concepts: `You are a study assistant helping an Australian university student.
Analyse this lecture recording and extract all **key concepts, definitions, theories, and models** mentioned by the lecturer.

Format your response as:
1. A bulleted glossary ‚Äî each entry: **Term** ‚Äî definition or explanation as given in the lecture
2. Group terms into logical categories if there are many
3. Note if any concept is flagged by the lecturer as "important" or likely to appear in assessments/exams

Use plain language that a student can quickly revise from. Use Australian spelling (e.g. "organise", "analyse", "behaviour").`,

    assessment: `You are a study assistant helping an Australian university student.
Watch this lecture recording carefully for any **assessment-related information** the lecturer mentions.

Extract and list:
- Assignment/assessment due dates (with the date and task name)
- Exam dates, times, or formats mentioned
- Topics the lecturer hints will be in assessments or exams ("this is important", "likely to come up", etc.)
- Tutorial participation or attendance requirements
- Any changes to the unit outline or marking criteria
- Recommended readings or resources

If nothing is mentioned in these categories, clearly state "Not mentioned in this lecture."
Use Australian university terminology throughout.`,

    questions: `You are a study assistant helping an Australian university student.
Based on this lecture recording, generate **10 study questions** that test understanding of the key content.

Include a mix of:
- 4 short-answer questions (factual recall)
- 3 application questions (apply the concept to a scenario)
- 2 analytical questions (compare, evaluate, or critique)
- 1 synthesis question (bring multiple concepts together)

For each question, provide a brief model answer (2‚Äì4 sentences) underneath in smaller text.
Format clearly with question numbers. Use Australian university conventions.`,

    studyguide: `You are a study assistant helping an Australian university student who has only 5 minutes to revise this lecture.
Create a **concise 5-minute study guide** covering everything essential from this lecture recording.

Structure it as:
## The Big Idea (1‚Äì2 sentences)
## Core Concepts (bullet list, max 8 points)
## Key Terms to Know (3‚Äì6 terms with one-line definitions)
## Things to Remember for Assessment (if any were mentioned)
## One Exam Tip (a mnemonic, analogy, or quick memory trick for the hardest concept)

Keep it punchy and practical. Use Australian university language.`
};

const ACTION_LABELS = {
    timestamps: 'üïê Timestamped Summary',
    concepts:   'üìñ Key Concepts & Definitions',
    assessment: 'üìÖ Assessment & Due Dates',
    questions:  '‚ùì Study Questions',
    studyguide: '‚ö° 5-Minute Study Guide',
};

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if (apiKey) {
    apiKeyInput.value = apiKey;
    initAI();
}

// ‚îÄ‚îÄ API Key ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initAI() {
    try {
        ai = new GoogleGenAI({ apiKey });
        apiStatus.textContent = '‚úÖ API key saved ‚Äî ready to analyse lectures.';
        apiStatus.className = 'api-status ok';
        updateControls();
    } catch {
        apiStatus.textContent = '‚ùå Invalid API key.';
        apiStatus.className = 'api-status err';
        ai = null;
        updateControls();
    }
}

saveApiKeyBtn.addEventListener('click', () => {
    apiKey = apiKeyInput.value.trim();
    if (apiKey) {
        localStorage.setItem('googleAiApiKey', apiKey);
        initAI();
    } else {
        apiStatus.textContent = 'Please enter a valid API key.';
        apiStatus.className = 'api-status err';
    }
});

apiKeyInput.addEventListener('keydown', e => { if (e.key === 'Enter') saveApiKeyBtn.click(); });

// ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
    });
});

// ‚îÄ‚îÄ File Upload & Files API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('over'); });
dropzone.addEventListener('dragleave', () => dropzone.classList.remove('over'));
dropzone.addEventListener('drop', e => {
    e.preventDefault();
    dropzone.classList.remove('over');
    if (e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', e => { if (e.target.files[0]) processFile(e.target.files[0]); });

async function processFile(file) {
    if (!file.type.startsWith('video/')) {
        alert('Please upload a video file (MP4, WebM, MOV, etc.)');
        return;
    }
    if (!ai) {
        alert('Please save your API key first.');
        return;
    }

    // Reset YouTube state
    youtubeUrl = null;
    urlLoaded.style.display = 'none';
    uploadedFileUri = null;

    // Show local preview while uploading
    const localUrl = URL.createObjectURL(file);
    videoPreview.src = localUrl;
    videoPreview.style.display = 'block';

    fileInfo.style.display = 'none';
    uploadProgress.classList.add('visible');
    progressFill.style.width = '0%';
    progressLabel.textContent = 'Uploading to Files API‚Ä¶';
    updateControls();

    try {
        // Simulate upload progress (Files API doesn't expose progress)
        const progressInterval = simulateProgress();

        const uploaded = await ai.files.upload({
            file: file,
            config: { mimeType: file.type },
        });

        clearInterval(progressInterval);
        progressFill.style.width = '70%';
        progressLabel.textContent = 'Processing video‚Ä¶ (this may take a moment)';

        // Poll until ACTIVE
        let fileStatus = await ai.files.get({ name: uploaded.name });
        let polls = 0;
        while (fileStatus.state === 'PROCESSING' && polls < 60) {
            await sleep(3000);
            fileStatus = await ai.files.get({ name: uploaded.name });
            polls++;
            const pct = 70 + Math.min(polls * 0.5, 25);
            progressFill.style.width = pct + '%';
        }

        if (fileStatus.state !== 'ACTIVE') {
            throw new Error(`File ended in state: ${fileStatus.state}`);
        }

        progressFill.style.width = '100%';
        progressLabel.textContent = 'Ready!';
        await sleep(600);

        uploadedFileUri = fileStatus.uri;
        uploadedFileMime = fileStatus.mimeType || file.type;

        uploadProgress.classList.remove('visible');
        fileInfo.style.display = 'block';
        fileInfo.innerHTML = `‚úÖ <strong>${file.name}</strong> uploaded and ready (${formatBytes(file.size)})`;
        updateControls();

    } catch (err) {
        uploadProgress.classList.remove('visible');
        fileInfo.style.display = 'block';
        fileInfo.style.background = '#fef2f2';
        fileInfo.style.borderColor = '#fecaca';
        fileInfo.style.color = 'var(--danger)';
        fileInfo.textContent = '‚ùå Upload failed: ' + err.message;
        console.error('Upload error:', err);
    }
}

function simulateProgress() {
    let pct = 0;
    return setInterval(() => {
        pct = Math.min(pct + Math.random() * 4, 65);
        progressFill.style.width = pct + '%';
    }, 400);
}

// ‚îÄ‚îÄ YouTube URL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.loadVideoUrl = function() {
    const url = videoUrlInput.value.trim();
    if (!url) { alert('Please enter a video URL.'); return; }

    youtubeUrl = url;
    uploadedFileUri = null;
    uploadedFileMime = null;
    videoPreview.style.display = 'none';
    fileInfo.style.display = 'none';

    urlLoaded.style.display = 'block';
    urlLoaded.innerHTML = `‚úÖ Video URL loaded: <strong>${url}</strong>`;
    updateControls();
};

videoUrlInput.addEventListener('keydown', e => { if (e.key === 'Enter') window.loadVideoUrl(); });

// ‚îÄ‚îÄ Controls state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateControls() {
    const hasVideo = !!(uploadedFileUri || youtubeUrl);
    const ready = !!(ai && hasVideo && !isProcessing);

    document.querySelectorAll('.action-btn').forEach(b => b.disabled = !ready);
    customPrompt.disabled = !ready;
    askBtn.disabled = !ready;
}

// ‚îÄ‚îÄ Run action ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.runAction = async function(btn) {
    const key = btn.dataset.prompt;
    const prompt = PROMPTS[key];
    const label = ACTION_LABELS[key];
    await analyse(prompt, label);
};

window.runCustom = async function() {
    const text = customPrompt.value.trim();
    if (!text) { alert('Please enter a question or instruction.'); return; }
    await analyse(text, 'üí¨ Custom Query');
};

async function analyse(prompt, label) {
    if (isProcessing) return;
    if (!ai) { alert('Please save your API key first.'); return; }
    if (!uploadedFileUri && !youtubeUrl) { alert('Please load a lecture video first.'); return; }

    isProcessing = true;
    updateControls();

    statusBar.classList.add('active');
    statusText.textContent = 'Analysing lecture with Gemini‚Ä¶';
    outputArea.innerHTML = '';
    outputLabel.textContent = label;
    copyBtn.classList.remove('visible');

    try {
        // Build content parts
        const videoPart = uploadedFileUri
            ? { fileData: { fileUri: uploadedFileUri, mimeType: uploadedFileMime } }
            : { fileData: { fileUri: youtubeUrl } };

        const response = await ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: [{
                parts: [ videoPart, { text: prompt } ]
            }]
        });

        const text = response.text;
        outputArea.innerHTML = renderMarkdown(text);
        copyBtn.classList.add('visible');

    } catch (err) {
        outputArea.innerHTML = `<span style="color:var(--danger)">‚ùå Error: ${escapeHtml(err.message)}</span>`;
        console.error('Gemini error:', err);
    } finally {
        statusBar.classList.remove('active');
        isProcessing = false;
        updateControls();
    }
}

// ‚îÄ‚îÄ Copy output ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.copyOutput = function() {
    const text = outputArea.innerText;
    navigator.clipboard.writeText(text).then(() => {
        copyBtn.textContent = 'Copied!';
        setTimeout(() => { copyBtn.textContent = 'Copy'; }, 2000);
    });
};

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

function formatBytes(bytes) {
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function escapeHtml(str) {
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

// Lightweight markdown-to-HTML renderer
function renderMarkdown(text) {
    let html = escapeHtml(text);

    // Headings
    html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
    html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
    html = html.replace(/^# (.+)$/gm, '<h2>$1</h2>');

    // Bold
    html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

    // Timestamps like [00:45] or [1:02:33]
    html = html.replace(/\[(\d{1,2}:\d{2}(?::\d{2})?)\]/g, '<span class="ts-badge">$1</span>');

    // Bullet lists
    html = html.replace(/^[-*] (.+)$/gm, '<li>$1</li>');
    html = html.replace(/(<li>.*<\/li>\n?)+/g, match => `<ul style="padding-left:20px;margin:8px 0">${match}</ul>`);

    // Numbered lists
    html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');

    // Horizontal rules
    html = html.replace(/^---+$/gm, '<hr style="border:none;border-top:1px solid var(--border);margin:12px 0">');

    // Newlines ‚Üí breaks (outside tags)
    html = html.replace(/\n\n/g, '<br><br>');
    html = html.replace(/\n/g, '<br>');

    return html;
}
</script>
</body>
</html>
