<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>University Handbook Analyser</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: #f0f4f8;
            min-height: 100vh;
            padding: 20px;
            color: #1a2744;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 60, 140, 0.12);
            overflow: hidden;
        }

        /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
        .header {
            background: linear-gradient(135deg, #003087 0%, #005eb8 100%);
            color: white;
            padding: 32px 36px 28px;
            position: relative;
            overflow: hidden;
        }

        .header::after {
            content: '';
            position: absolute;
            top: -40px;
            right: -40px;
            width: 220px;
            height: 220px;
            background: rgba(255, 205, 0, 0.1);
            border-radius: 50%;
            pointer-events: none;
        }

        .header-badge {
            display: inline-block;
            background: rgba(255, 205, 0, 0.2);
            border: 1px solid rgba(255, 205, 0, 0.4);
            color: #ffcd00;
            font-size: 0.72rem;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            padding: 4px 12px;
            border-radius: 20px;
            margin-bottom: 14px;
        }

        .header h1 {
            font-size: 2.1rem;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }

        .header p {
            opacity: 0.85;
            font-size: 1rem;
            line-height: 1.5;
            max-width: 580px;
        }

        .context-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 255, 255, 0.15);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-top: 16px;
        }

        .context-pill .dot {
            width: 8px;
            height: 8px;
            background: #4cff91;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* ‚îÄ‚îÄ API Key ‚îÄ‚îÄ */
        .api-key-section {
            padding: 16px 36px;
            background: #f8faff;
            border-bottom: 1px solid #e8eef7;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .api-key-section label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #4a5568;
            white-space: nowrap;
        }

        #apiKeyInput {
            flex: 1;
            min-width: 220px;
            padding: 9px 14px;
            border: 2px solid #dde3ef;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #1a2744;
            transition: border-color 0.2s;
        }

        #apiKeyInput:focus {
            outline: none;
            border-color: #003087;
        }

        #saveApiKey {
            padding: 9px 20px;
            background: #003087;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: background 0.2s;
            white-space: nowrap;
        }

        #saveApiKey:hover { background: #004db3; }

        .api-status {
            font-size: 0.8rem;
            color: #718096;
            width: 100%;
            margin-top: -4px;
        }

        .api-status.success { color: #2a9d5c; }

        /* ‚îÄ‚îÄ Main content ‚îÄ‚îÄ */
        .content {
            padding: 32px 36px;
        }

        /* ‚îÄ‚îÄ Upload zone ‚îÄ‚îÄ */
        .upload-zone {
            border: 2px dashed #c4d0e8;
            border-radius: 12px;
            padding: 36px 24px;
            text-align: center;
            background: #f8faff;
            transition: all 0.2s;
            margin-bottom: 24px;
            cursor: pointer;
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: #003087;
            background: #eef3ff;
        }

        .upload-icon {
            font-size: 2.8rem;
            margin-bottom: 12px;
        }

        .upload-zone h3 {
            font-size: 1.1rem;
            color: #1a2744;
            margin-bottom: 6px;
        }

        .upload-zone p {
            color: #718096;
            font-size: 0.88rem;
            margin-bottom: 18px;
        }

        .upload-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn-primary {
            padding: 10px 22px;
            background: #003087;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: background 0.2s;
        }

        .btn-primary:hover { background: #004db3; }
        .btn-primary:disabled { background: #a0aec0; cursor: not-allowed; }

        .btn-secondary {
            padding: 10px 22px;
            background: white;
            color: #003087;
            border: 2px solid #003087;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-secondary:hover { background: #eef3ff; }

        .url-input-row {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e2e8f0;
        }

        .url-input-row input {
            flex: 1;
            padding: 9px 14px;
            border: 2px solid #dde3ef;
            border-radius: 8px;
            font-size: 0.85rem;
            color: #1a2744;
        }

        .url-input-row input:focus {
            outline: none;
            border-color: #003087;
        }

        input[type="file"] { display: none; }

        /* ‚îÄ‚îÄ Upload progress ‚îÄ‚îÄ */
        .upload-progress {
            display: none;
            background: #eef3ff;
            border: 1px solid #c4d0e8;
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 24px;
        }

        .upload-progress.visible { display: block; }

        .progress-label {
            font-size: 0.88rem;
            color: #4a5568;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #c4d0e8;
            border-top-color: #003087;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            flex-shrink: 0;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .progress-bar-track {
            height: 6px;
            background: #dde3ef;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #003087, #005eb8);
            border-radius: 3px;
            width: 0%;
            transition: width 0.4s ease;
        }

        /* ‚îÄ‚îÄ Stats panel ‚îÄ‚îÄ */
        .stats-panel {
            display: none;
            margin-bottom: 24px;
        }

        .stats-panel.visible { display: block; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }

        .stat-card {
            background: #f8faff;
            border: 1px solid #e2eaf5;
            border-radius: 10px;
            padding: 14px 16px;
        }

        .stat-label {
            font-size: 0.72rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: #718096;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #003087;
        }

        .stat-sub {
            font-size: 0.75rem;
            color: #a0aec0;
            margin-top: 2px;
        }

        .context-bar {
            background: #f0f4f8;
            border-radius: 8px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .context-bar-label {
            font-size: 0.8rem;
            color: #4a5568;
            white-space: nowrap;
        }

        .context-bar-track {
            flex: 1;
            height: 8px;
            background: #dde3ef;
            border-radius: 4px;
            overflow: hidden;
        }

        .context-bar-fill {
            height: 100%;
            border-radius: 4px;
            background: linear-gradient(90deg, #003087, #5ba3e8);
            transition: width 0.6s ease;
        }

        .context-bar-pct {
            font-size: 0.8rem;
            font-weight: 700;
            color: #003087;
            white-space: nowrap;
        }

        /* ‚îÄ‚îÄ Document name chip ‚îÄ‚îÄ */
        .doc-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #e8f0ff;
            border: 1px solid #c4d4f5;
            color: #003087;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 12px;
        }

        /* ‚îÄ‚îÄ Model selector ‚îÄ‚îÄ */
        .model-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 22px;
            flex-wrap: wrap;
        }

        .model-row label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #4a5568;
        }

        #modelSelect {
            padding: 8px 14px;
            border: 2px solid #dde3ef;
            border-radius: 8px;
            font-size: 0.88rem;
            color: #1a2744;
            background: white;
            cursor: pointer;
        }

        #modelSelect:focus {
            outline: none;
            border-color: #003087;
        }

        /* ‚îÄ‚îÄ Quick questions ‚îÄ‚îÄ */
        .quick-questions {
            margin-bottom: 20px;
        }

        .quick-questions label {
            display: block;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: #718096;
            margin-bottom: 10px;
        }

        .chips {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .chip {
            padding: 7px 14px;
            background: #f0f4f8;
            border: 1.5px solid #dde3ef;
            border-radius: 20px;
            font-size: 0.82rem;
            color: #1a2744;
            cursor: pointer;
            transition: all 0.2s;
            line-height: 1.3;
        }

        .chip:hover {
            background: #e8f0ff;
            border-color: #003087;
            color: #003087;
        }

        /* ‚îÄ‚îÄ Q&A section ‚îÄ‚îÄ */
        .qa-section {
            margin-bottom: 20px;
        }

        .qa-input-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        #questionInput {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #dde3ef;
            border-radius: 10px;
            font-size: 0.95rem;
            color: #1a2744;
            resize: vertical;
            min-height: 72px;
            font-family: inherit;
            line-height: 1.5;
            transition: border-color 0.2s;
        }

        #questionInput:focus {
            outline: none;
            border-color: #003087;
        }

        .ask-btn {
            padding: 12px 24px;
            background: #003087;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 700;
            transition: background 0.2s;
            white-space: nowrap;
            align-self: flex-end;
            min-height: 48px;
        }

        .ask-btn:hover { background: #004db3; }
        .ask-btn:disabled { background: #a0aec0; cursor: not-allowed; }

        /* ‚îÄ‚îÄ Response area ‚îÄ‚îÄ */
        .response-area {
            background: #f8faff;
            border: 1px solid #e2eaf5;
            border-radius: 12px;
            min-height: 200px;
            padding: 24px;
        }

        .response-placeholder {
            text-align: center;
            color: #a0aec0;
            padding: 40px 20px;
        }

        .response-placeholder .icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }

        .response-placeholder p {
            font-size: 0.9rem;
        }

        .response-loading {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #4a5568;
            font-size: 0.95rem;
        }

        .response-content {
            color: #1a2744;
            line-height: 1.75;
            font-size: 0.95rem;
        }

        .response-content h1, .response-content h2, .response-content h3 {
            color: #003087;
            margin: 16px 0 8px;
            font-weight: 700;
        }

        .response-content h1 { font-size: 1.3rem; }
        .response-content h2 { font-size: 1.15rem; }
        .response-content h3 { font-size: 1rem; }

        .response-content p { margin-bottom: 10px; }

        .response-content ul, .response-content ol {
            margin: 8px 0 10px 22px;
        }

        .response-content li { margin-bottom: 4px; }

        .response-content strong { color: #003087; }

        .response-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
            font-size: 0.88rem;
        }

        .response-content th {
            background: #003087;
            color: white;
            padding: 8px 12px;
            text-align: left;
        }

        .response-content td {
            padding: 8px 12px;
            border-bottom: 1px solid #e2eaf5;
        }

        .response-content tr:nth-child(even) td {
            background: #f0f4f8;
        }

        .response-content code {
            background: #e8eef8;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.88em;
        }

        .response-content blockquote {
            border-left: 3px solid #003087;
            padding-left: 14px;
            color: #4a5568;
            margin: 10px 0;
        }

        /* ‚îÄ‚îÄ Error ‚îÄ‚îÄ */
        .error-box {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 8px;
            padding: 14px 18px;
            color: #c53030;
            font-size: 0.88rem;
        }

        /* ‚îÄ‚îÄ Footer note ‚îÄ‚îÄ */
        .footer-note {
            margin-top: 20px;
            padding: 14px 18px;
            background: #fffbeb;
            border: 1px solid #f6e05e;
            border-radius: 8px;
            font-size: 0.82rem;
            color: #744210;
            line-height: 1.5;
        }

        /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
        @media (max-width: 640px) {
            .content { padding: 24px 20px; }
            .header { padding: 24px 20px; }
            .header h1 { font-size: 1.6rem; }
            .api-key-section { padding: 14px 20px; }
            .qa-input-row { flex-direction: column; }
            .ask-btn { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-badge">Long Context ¬∑ Gemini API</div>
            <h1>üìã University Handbook Analyser</h1>
            <p>Upload your unit outline, course handbook, or exam timetable PDF ‚Äî then ask any question about it. Powered by Gemini's large context window, which can process hundreds of pages at once.</p>
            <div class="context-pill">
                <span class="dot"></span>
                Up to 1 million tokens ‚Äî entire handbooks in a single prompt
            </div>
        </div>

        <!-- API Key -->
        <div class="api-key-section">
            <label for="apiKeyInput">Google AI API Key</label>
            <input type="password" id="apiKeyInput" placeholder="AIza..." maxlength="100">
            <button id="saveApiKey">Save Key</button>
            <div class="api-status" id="apiStatus">Enter your Google AI API key to get started</div>
        </div>

        <!-- Main content -->
        <div class="content">

            <!-- Model selector -->
            <div class="model-row">
                <label for="modelSelect">Model:</label>
                <select id="modelSelect">
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash (Recommended ‚Äî fast &amp; large context)</option>
                    <option value="gemini-2.5-pro">Gemini 2.5 Pro (Best analysis)</option>
                    <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash-Lite (Fastest)</option>
                </select>
            </div>

            <!-- Upload zone -->
            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">üìÑ</div>
                <h3>Upload your university document</h3>
                <p>Unit outline ¬∑ Course handbook ¬∑ Exam timetable ¬∑ Assessment guide<br>Drag &amp; drop a PDF, or choose one below</p>
                <div class="upload-actions">
                    <button class="btn-primary" onclick="document.getElementById('fileInput').click()">Choose PDF</button>
                    <input type="file" id="fileInput" accept=".pdf">
                    <span style="color:#a0aec0; font-size:0.85rem;">or load from URL</span>
                </div>
                <div class="url-input-row">
                    <input type="url" id="pdfUrl" placeholder="https://university.edu.au/unit-outline.pdf">
                    <button class="btn-secondary" onclick="loadFromUrl()">Load URL</button>
                </div>
            </div>

            <!-- Upload progress -->
            <div class="upload-progress" id="uploadProgress">
                <div class="progress-label">
                    <div class="spinner"></div>
                    <span id="progressLabel">Uploading to Gemini Files API‚Ä¶</span>
                </div>
                <div class="progress-bar-track">
                    <div class="progress-bar-fill" id="progressBar"></div>
                </div>
            </div>

            <!-- Stats panel -->
            <div class="stats-panel" id="statsPanel">
                <div class="doc-chip" id="docChip">üìÑ <span id="docName">document.pdf</span></div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">File Size</div>
                        <div class="stat-value" id="statSize">‚Äî</div>
                        <div class="stat-sub">PDF document</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Token Count</div>
                        <div class="stat-value" id="statTokens">‚Äî</div>
                        <div class="stat-sub">estimated by Gemini</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Est. Pages</div>
                        <div class="stat-value" id="statPages">‚Äî</div>
                        <div class="stat-sub">approx. 350 tokens/page</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Status</div>
                        <div class="stat-value" style="font-size:1rem; color:#2a9d5c;">Ready ‚úì</div>
                        <div class="stat-sub">document processed</div>
                    </div>
                </div>
                <div class="context-bar">
                    <span class="context-bar-label">Context window used:</span>
                    <div class="context-bar-track">
                        <div class="context-bar-fill" id="contextBarFill" style="width:0%"></div>
                    </div>
                    <span class="context-bar-pct" id="contextBarPct">0%</span>
                </div>
            </div>

            <!-- Quick questions -->
            <div class="quick-questions">
                <label>Quick questions ‚Äî click to use</label>
                <div class="chips">
                    <div class="chip" onclick="useChip(this)">What are all the assessment items, their weightings, and due dates?</div>
                    <div class="chip" onclick="useChip(this)">What is the late submission and special consideration policy?</div>
                    <div class="chip" onclick="useChip(this)">What are the hurdle requirements for this unit?</div>
                    <div class="chip" onclick="useChip(this)">List the contact hours ‚Äî lectures, tutorials, labs ‚Äî for each unit.</div>
                    <div class="chip" onclick="useChip(this)">When are the final exams and what topics do they cover?</div>
                </div>
            </div>

            <!-- Q&A -->
            <div class="qa-section">
                <div class="qa-input-row">
                    <textarea id="questionInput" placeholder="Ask anything about your handbook‚Ä¶ e.g. &quot;What is the Turnitin submission process?&quot; or &quot;Is there a supplementary assessment option?&quot;"></textarea>
                    <button class="ask-btn" id="askBtn" disabled onclick="askQuestion()">Ask Gemini</button>
                </div>
            </div>

            <!-- Response -->
            <div class="response-area" id="responseArea">
                <div class="response-placeholder" id="responsePlaceholder">
                    <div class="icon">üéì</div>
                    <p>Upload a PDF above, then ask a question about your unit outline or handbook.<br>
                    Gemini will read the entire document ‚Äî no chunking required.</p>
                </div>
            </div>

            <div class="footer-note">
                <strong>How it works:</strong> Your PDF is uploaded to the Gemini Files API, which processes the full document and gives Gemini a persistent reference to it. The large context window means the entire handbook is analysed at once ‚Äî not split into chunks. Works with unit outlines, course handbooks, LMS-exported PDFs, exam timetables, and assessment guides.
            </div>

        </div>
    </div>

    <script type="module">
        import { GoogleGenAI } from "https://esm.sh/@google/genai@latest";

        const CONTEXT_WINDOW = 1_000_000; // tokens ‚Äî Gemini 2.5 Flash/Pro

        let apiKey = localStorage.getItem('googleAiApiKey') || '';
        let ai = null;
        let geminiFile = null;   // uploaded file reference
        let fileSize = 0;

        // Elements
        const apiKeyInput  = document.getElementById('apiKeyInput');
        const saveApiKeyBtn = document.getElementById('saveApiKey');
        const apiStatus    = document.getElementById('apiStatus');
        const modelSelect  = document.getElementById('modelSelect');
        const uploadZone   = document.getElementById('uploadZone');
        const fileInput    = document.getElementById('fileInput');
        const pdfUrlInput  = document.getElementById('pdfUrl');
        const uploadProgress = document.getElementById('uploadProgress');
        const progressLabel  = document.getElementById('progressLabel');
        const progressBar    = document.getElementById('progressBar');
        const statsPanel   = document.getElementById('statsPanel');
        const docName      = document.getElementById('docName');
        const statSize     = document.getElementById('statSize');
        const statTokens   = document.getElementById('statTokens');
        const statPages    = document.getElementById('statPages');
        const contextBarFill = document.getElementById('contextBarFill');
        const contextBarPct  = document.getElementById('contextBarPct');
        const questionInput = document.getElementById('questionInput');
        const askBtn       = document.getElementById('askBtn');
        const responseArea = document.getElementById('responseArea');
        const responsePlaceholder = document.getElementById('responsePlaceholder');

        // ‚îÄ‚îÄ Init API key ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        if (apiKey) {
            apiKeyInput.value = apiKey;
            initAI();
        }

        saveApiKeyBtn.addEventListener('click', () => {
            apiKey = apiKeyInput.value.trim();
            if (apiKey) {
                localStorage.setItem('googleAiApiKey', apiKey);
                initAI();
            } else {
                apiStatus.textContent = 'Please enter a valid API key.';
                apiStatus.className = 'api-status';
            }
        });

        function initAI() {
            try {
                ai = new GoogleGenAI({ apiKey });
                apiStatus.textContent = '‚úÖ API key saved ‚Äî ready to analyse documents.';
                apiStatus.className = 'api-status success';
            } catch (e) {
                apiStatus.textContent = '‚ùå Invalid API key.';
                apiStatus.className = 'api-status';
                ai = null;
            }
        }

        // ‚îÄ‚îÄ Drag & drop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        uploadZone.addEventListener('dragover', e => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));

        uploadZone.addEventListener('drop', e => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) processLocalFile(file);
        });

        fileInput.addEventListener('change', e => {
            if (e.target.files[0]) processLocalFile(e.target.files[0]);
        });

        // ‚îÄ‚îÄ Local file upload ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function processLocalFile(file) {
            if (!ai) { alert('Please enter your API key first.'); return; }
            if (!file.type.includes('pdf') && !file.name.endsWith('.pdf')) {
                alert('Please upload a PDF file.'); return;
            }

            fileSize = file.size;
            const name = file.name;
            const blob = new Blob([await file.arrayBuffer()], { type: 'application/pdf' });
            await uploadToGemini(blob, name);
        }

        // ‚îÄ‚îÄ URL load ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.loadFromUrl = async () => {
            const url = pdfUrlInput.value.trim();
            if (!url) { alert('Please enter a PDF URL.'); return; }
            if (!ai) { alert('Please enter your API key first.'); return; }

            showProgress('Fetching PDF from URL‚Ä¶', 10);
            try {
                const resp = await fetch(url);
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const buffer = await resp.arrayBuffer();
                fileSize = buffer.byteLength;
                const name = url.split('/').pop().split('?')[0] || 'document.pdf';
                const blob = new Blob([buffer], { type: 'application/pdf' });
                await uploadToGemini(blob, name);
            } catch (err) {
                hideProgress();
                showError(`Failed to fetch PDF: ${err.message}. Check the URL and CORS policy.`);
            }
        };

        // ‚îÄ‚îÄ Core upload flow ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function uploadToGemini(blob, name) {
            showProgress('Uploading to Gemini Files API‚Ä¶', 20);
            askBtn.disabled = true;
            geminiFile = null;

            try {
                const uploaded = await ai.files.upload({
                    file: blob,
                    config: { displayName: name, mimeType: 'application/pdf' }
                });

                showProgress('Processing document‚Ä¶', 55);
                setProgressBar(55);

                // Poll until ready
                let fileStatus = await ai.files.get({ name: uploaded.name });
                let attempts = 0;
                while (fileStatus.state === 'PROCESSING' && attempts < 30) {
                    await sleep(2000);
                    fileStatus = await ai.files.get({ name: uploaded.name });
                    attempts++;
                    setProgressBar(55 + Math.min(35, attempts * 2));
                }

                if (fileStatus.state === 'FAILED') {
                    throw new Error('Gemini could not process this PDF.');
                }

                geminiFile = fileStatus;
                showProgress('Counting tokens‚Ä¶', 95);

                // Count tokens
                let totalTokens = null;
                try {
                    const tokenResp = await ai.models.countTokens({
                        model: modelSelect.value,
                        contents: [{
                            parts: [{ fileData: { mimeType: geminiFile.mimeType, fileUri: geminiFile.uri } }]
                        }]
                    });
                    totalTokens = tokenResp.totalTokens;
                } catch (e) {
                    console.warn('Token count failed:', e);
                }

                hideProgress();
                showStats(name, totalTokens);
                askBtn.disabled = false;

            } catch (err) {
                hideProgress();
                showError(`Upload failed: ${err.message}`);
                console.error(err);
            }
        }

        // ‚îÄ‚îÄ Stats display ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showStats(name, tokens) {
            docName.textContent = name;
            statSize.textContent = formatSize(fileSize);
            statTokens.textContent = tokens != null ? tokens.toLocaleString() : '‚Äî';
            statPages.textContent = tokens != null ? Math.round(tokens / 350).toLocaleString() : '‚Äî';

            if (tokens != null) {
                const pct = Math.min(100, (tokens / CONTEXT_WINDOW) * 100);
                contextBarFill.style.width = pct.toFixed(1) + '%';
                contextBarPct.textContent = pct.toFixed(1) + '%';
            }

            statsPanel.classList.add('visible');
        }

        // ‚îÄ‚îÄ Progress helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showProgress(msg, pct) {
            progressLabel.textContent = msg;
            setProgressBar(pct);
            uploadProgress.classList.add('visible');
        }

        function setProgressBar(pct) {
            progressBar.style.width = pct + '%';
        }

        function hideProgress() {
            uploadProgress.classList.remove('visible');
        }

        // ‚îÄ‚îÄ Quick question chips ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.useChip = (el) => {
            questionInput.value = el.textContent.trim();
            questionInput.focus();
        };

        // ‚îÄ‚îÄ Ask a question ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.askQuestion = async () => {
            if (!ai || !geminiFile) {
                showError('Please upload a document first.');
                return;
            }

            const question = questionInput.value.trim();
            if (!question) {
                questionInput.focus();
                return;
            }

            askBtn.disabled = true;
            setResponseLoading();

            try {
                const systemPrompt = `You are an expert academic advisor helping an Australian university student understand their course documents. 
When answering:
- Use Australian university terminology: unit outlines, hurdle requirements, assessment weightings, tutorial participation, special consideration, supplementary assessment, LMS, Turnitin, etc.
- Format your answers clearly with headings and bullet points where appropriate
- Quote specific text from the document when relevant
- If the document doesn't contain the answer, say so clearly
- Be concise but thorough`;

                const response = await ai.models.generateContent({
                    model: modelSelect.value,
                    contents: [
                        {
                            parts: [
                                { fileData: { mimeType: geminiFile.mimeType, fileUri: geminiFile.uri } },
                                { text: `${systemPrompt}\n\nStudent question: ${question}` }
                            ]
                        }
                    ]
                });

                if (!response || !response.text) {
                    throw new Error('Empty response from Gemini.');
                }

                showResponse(response.text);

            } catch (err) {
                showError(`Error: ${err.message}`);
                console.error(err);
            }

            askBtn.disabled = false;
        };

        // ‚îÄ‚îÄ Enter to submit (Shift+Enter for newline) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        questionInput.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!askBtn.disabled) askQuestion();
            }
        });

        // ‚îÄ‚îÄ Response rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function setResponseLoading() {
            responseArea.innerHTML = `
                <div class="response-loading">
                    <div class="spinner"></div>
                    Gemini is reading your document‚Ä¶
                </div>`;
        }

        function showResponse(text) {
            const html = markdownToHtml(text);
            responseArea.innerHTML = `<div class="response-content">${html}</div>`;
        }

        function showError(msg) {
            responseArea.innerHTML = `<div class="error-box">‚ö†Ô∏è ${escapeHtml(msg)}</div>`;
        }

        // Lightweight markdown ‚Üí HTML
        function markdownToHtml(md) {
            return md
                .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                // headings
                .replace(/^### (.+)$/gm, '<h3>$1</h3>')
                .replace(/^## (.+)$/gm, '<h2>$1</h2>')
                .replace(/^# (.+)$/gm, '<h1>$1</h1>')
                // bold & italic
                .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                // code
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                // blockquote
                .replace(/^&gt; (.+)$/gm, '<blockquote>$1</blockquote>')
                // unordered lists
                .replace(/^\s*[-*] (.+)$/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>')
                // ordered lists
                .replace(/^\s*\d+\. (.+)$/gm, '<li>$1</li>')
                // horizontal rule
                .replace(/^---$/gm, '<hr>')
                // paragraphs (double newline ‚Üí p)
                .replace(/\n\n/g, '</p><p>')
                // single newlines inside paragraphs
                .replace(/\n/g, '<br>')
                // wrap in paragraph
                .replace(/^/, '<p>')
                .replace(/$/, '</p>')
                // clean up empty paragraphs
                .replace(/<p>\s*<\/p>/g, '')
                .replace(/<p>(<h[123]>)/g, '$1')
                .replace(/(<\/h[123]>)<\/p>/g, '$1')
                .replace(/<p>(<ul>)/g, '$1')
                .replace(/(<\/ul>)<\/p>/g, '$1')
                .replace(/<p>(<blockquote>)/g, '$1')
                .replace(/(<\/blockquote>)<\/p>/g, '$1')
                .replace(/<p>(<hr>)<\/p>/g, '$1');
        }

        function escapeHtml(s) {
            return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const u = ['B','KB','MB','GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + u[i];
        }

        function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
    </script>
</body>
</html>
