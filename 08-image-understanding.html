<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Map & Room Finder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f766e 0%, #1a3d6e 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 24px 48px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
            color: white;
            padding: 28px 32px;
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .header-icon {
            font-size: 2.8rem;
            flex-shrink: 0;
        }

        .header-text h1 {
            font-size: 1.8rem;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .header-text p {
            opacity: 0.82;
            font-size: 0.95rem;
            margin-top: 4px;
        }

        .header-badge {
            margin-left: auto;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.78rem;
            letter-spacing: 0.3px;
            white-space: nowrap;
        }

        /* API Key Section */
        .api-key-section {
            padding: 16px 32px;
            background: #f4f6f9;
            border-bottom: 1px solid #dde3ec;
        }

        .api-key-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #apiKeyInput {
            flex: 1;
            padding: 9px 14px;
            border: 1.5px solid #c8d0dc;
            border-radius: 8px;
            font-size: 0.88rem;
            transition: border-color 0.2s;
            background: white;
        }

        #apiKeyInput:focus {
            outline: none;
            border-color: #14b8a6;
        }

        #saveApiKey {
            padding: 9px 20px;
            background: #14b8a6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.88rem;
            font-weight: 500;
            transition: background 0.2s;
            white-space: nowrap;
        }

        #saveApiKey:hover {
            background: #0f766e;
        }

        .api-status {
            margin-top: 7px;
            font-size: 0.78rem;
            color: #6b7a90;
        }

        .api-status.success { color: #1b7a3e; }
        .api-status.error   { color: #c62828; }

        /* Main layout */
        .content-section {
            padding: 28px 32px;
        }

        /* Upload zone */
        .upload-zone {
            border: 2px dashed #c8d0dc;
            border-radius: 12px;
            padding: 36px 24px;
            text-align: center;
            transition: border-color 0.2s, background 0.2s;
            cursor: pointer;
            background: #fafbfd;
            margin-bottom: 24px;
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: #14b8a6;
            background: #eef3fb;
        }

        .upload-zone.has-image {
            border-style: solid;
            border-color: #14b8a6;
            padding: 16px;
            background: white;
        }

        .upload-icon-large {
            font-size: 2.6rem;
            margin-bottom: 12px;
        }

        .upload-zone h3 {
            font-size: 1.05rem;
            font-weight: 600;
            color: #1a2a3a;
            margin-bottom: 6px;
        }

        .upload-zone p {
            font-size: 0.86rem;
            color: #6b7a90;
            margin-bottom: 14px;
        }

        .file-input { display: none; }

        .upload-btn {
            padding: 9px 22px;
            background: #14b8a6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.88rem;
            font-weight: 500;
            transition: background 0.2s;
        }

        .upload-btn:hover { background: #0f766e; }

        .image-preview-wrapper {
            display: none;
            justify-content: center;
        }

        .image-preview-wrapper.visible { display: flex; }

        #imagePreview {
            max-width: 100%;
            max-height: 320px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            object-fit: contain;
        }

        .change-image-btn {
            display: none;
            margin-top: 10px;
            padding: 6px 16px;
            background: transparent;
            color: #14b8a6;
            border: 1.5px solid #14b8a6;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.82rem;
            transition: all 0.2s;
        }

        .change-image-btn.visible { display: inline-block; }
        .change-image-btn:hover {
            background: #14b8a6;
            color: white;
        }

        /* Image type hints */
        .image-types {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 10px;
        }

        .image-type-tag {
            background: #e8eef7;
            color: #14b8a6;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Question section */
        .question-section {
            margin-bottom: 24px;
        }

        .question-section label {
            display: block;
            font-weight: 600;
            font-size: 0.9rem;
            color: #1a2a3a;
            margin-bottom: 10px;
        }

        .quick-questions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 14px;
        }

        .quick-btn {
            padding: 7px 13px;
            background: #eef3fb;
            color: #14b8a6;
            border: 1.5px solid #c5d5ee;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.18s;
            text-align: left;
            line-height: 1.3;
        }

        .quick-btn:hover,
        .quick-btn.active {
            background: #14b8a6;
            color: white;
            border-color: #14b8a6;
        }

        .question-input-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        #questionInput {
            flex: 1;
            padding: 11px 14px;
            border: 1.5px solid #c8d0dc;
            border-radius: 10px;
            font-size: 0.92rem;
            resize: vertical;
            min-height: 52px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        #questionInput:focus {
            outline: none;
            border-color: #14b8a6;
        }

        .ask-btn {
            padding: 11px 28px;
            background: #14b8a6;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: background 0.2s;
            white-space: nowrap;
            height: 52px;
        }

        .ask-btn:hover { background: #0f766e; }

        .ask-btn:disabled {
            background: #b0bec5;
            cursor: not-allowed;
        }

        /* Results layout */
        .results-section {
            display: none;
            gap: 24px;
            margin-top: 24px;
        }

        .results-section.visible { display: grid; }

        @media (min-width: 720px) {
            .results-section.visible {
                grid-template-columns: 1fr 1fr;
            }
        }

        .result-panel {
            background: #f4f6f9;
            border-radius: 12px;
            padding: 20px;
            min-height: 200px;
        }

        .panel-header {
            font-weight: 600;
            font-size: 0.88rem;
            color: #1a2a3a;
            margin-bottom: 14px;
            padding-bottom: 10px;
            border-bottom: 2px solid #14b8a6;
            display: flex;
            align-items: center;
            gap: 7px;
        }

        .image-panel-inner {
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        #resultImage {
            max-width: 100%;
            max-height: 340px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            object-fit: contain;
        }

        .answer-content {
            color: #2c3a4a;
            font-size: 0.92rem;
            line-height: 1.65;
            white-space: pre-wrap;
        }

        .answer-content.loading {
            color: #6b7a90;
            font-style: italic;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #c8d0dc;
            border-top-color: #14b8a6;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            flex-shrink: 0;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Context / metadata below answer */
        .answer-meta {
            margin-top: 14px;
            padding-top: 12px;
            border-top: 1px solid #dde3ec;
            font-size: 0.78rem;
            color: #8a97a8;
        }

        /* Responsive tweaks */
        @media (max-width: 600px) {
            .header {
                flex-wrap: wrap;
                padding: 20px;
            }

            .header-badge { margin-left: 0; }

            .content-section {
                padding: 20px;
            }

            .api-key-section {
                padding: 14px 20px;
            }

            .api-key-group { flex-direction: column; }
            #saveApiKey { width: 100%; }

            .question-input-row { flex-direction: column; }
            .ask-btn { width: 100%; height: auto; padding: 12px; }
        }
    </style>
</head>
<body>
    <div class="container">

        <!-- Header -->
        <div class="header">
            <div class="header-icon">üó∫Ô∏è</div>
            <div class="header-text">
                <h1>Campus Map &amp; Room Finder</h1>
                <p>Upload a campus map, floor plan, or timetable ‚Äî ask Gemini anything about it</p>
            </div>
            <div class="header-badge">Powered by Gemini</div>
        </div>

        <!-- API Key -->
        <div class="api-key-section">
            <div class="api-key-group">
                <input type="password" id="apiKeyInput" placeholder="Enter your Google AI API key..." maxlength="120">
                <button id="saveApiKey">Save Key</button>
            </div>
            <div class="api-status" id="apiStatus">Enter your Google AI API key to get started</div>
        </div>

        <div class="content-section">

            <!-- Upload Zone -->
            <div class="upload-zone" id="uploadZone">
                <div id="uploadPrompt">
                    <div class="upload-icon-large">üìç</div>
                    <h3>Upload a Campus Image</h3>
                    <p>Drag &amp; drop, or click to choose a file</p>
                    <input type="file" id="fileInput" class="file-input" accept="image/*">
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">Choose Image</button>
                    <div class="image-types" style="margin-top: 14px;">
                        <span class="image-type-tag">üó∫Ô∏è Campus map</span>
                        <span class="image-type-tag">üè¢ Floor plan</span>
                        <span class="image-type-tag">üì∏ Building photo</span>
                        <span class="image-type-tag">üìÖ Class timetable</span>
                        <span class="image-type-tag">üìã Notice board</span>
                    </div>
                </div>
                <div class="image-preview-wrapper" id="imagePreviewWrapper">
                    <img id="imagePreview" alt="Uploaded campus image">
                </div>
            </div>
            <div style="text-align: center; margin-top: -16px; margin-bottom: 24px;">
                <button class="change-image-btn" id="changeImageBtn"
                    onclick="document.getElementById('fileInput').click()">
                    ‚Ü© Change image
                </button>
            </div>

            <!-- Question Section -->
            <div class="question-section">
                <label>Ask a question about your image</label>

                <div class="quick-questions" id="quickQuestions">
                    <button class="quick-btn" data-question="Where is Building 12 relative to the main entrance?">
                        üìå Where is Building 12 relative to the main entrance?
                    </button>
                    <button class="quick-btn" data-question="I need to get from the library to the engineering building ‚Äî what's the route?">
                        üö∂ Route: library ‚Üí engineering building
                    </button>
                    <button class="quick-btn" data-question="What floor is the student services office on in this floor plan?">
                        üè¢ What floor is student services on?
                    </button>
                    <button class="quick-btn" data-question="Is this the right lecture theatre? I have COMP1010 in Theatre N101.">
                        üéì Is this Theatre N101 for COMP1010?
                    </button>
                    <button class="quick-btn" data-question="What facilities are near the computer science building ‚Äî cafes, toilets, printing?">
                        ‚òï Facilities near CS building?
                    </button>
                </div>

                <div class="question-input-row">
                    <textarea id="questionInput" placeholder="e.g. Where do I go for an exam in room ENG 201? Or: What subjects are on Monday afternoon in this timetable?"></textarea>
                    <button class="ask-btn" id="askBtn" disabled>Ask Gemini</button>
                </div>
            </div>

            <!-- Results -->
            <div class="results-section" id="resultsSection">
                <div class="result-panel">
                    <div class="panel-header">üñºÔ∏è Your Image</div>
                    <div class="image-panel-inner">
                        <img id="resultImage" alt="Your uploaded image">
                    </div>
                </div>
                <div class="result-panel">
                    <div class="panel-header">üí¨ Gemini's Answer</div>
                    <div class="answer-content" id="answerContent">
                        Waiting for your question‚Ä¶
                    </div>
                    <div class="answer-meta" id="answerMeta"></div>
                </div>
            </div>

        </div><!-- /content-section -->
    </div><!-- /container -->

    <script type="module">
        import { GoogleGenAI } from "https://esm.sh/@google/genai@latest";

        let apiKey = localStorage.getItem('googleAiApiKey') || '';
        let ai = null;
        let uploadedFile = null;
        let uploadedBase64 = null;

        const apiKeyInput   = document.getElementById('apiKeyInput');
        const saveApiKeyBtn = document.getElementById('saveApiKey');
        const apiStatus     = document.getElementById('apiStatus');
        const uploadZone    = document.getElementById('uploadZone');
        const uploadPrompt  = document.getElementById('uploadPrompt');
        const fileInput     = document.getElementById('fileInput');
        const imagePreview  = document.getElementById('imagePreview');
        const imagePreviewWrapper = document.getElementById('imagePreviewWrapper');
        const changeImageBtn = document.getElementById('changeImageBtn');
        const questionInput = document.getElementById('questionInput');
        const askBtn        = document.getElementById('askBtn');
        const resultsSection = document.getElementById('resultsSection');
        const resultImage   = document.getElementById('resultImage');
        const answerContent = document.getElementById('answerContent');
        const answerMeta    = document.getElementById('answerMeta');
        const quickBtns     = document.querySelectorAll('.quick-btn');

        // Restore saved key
        if (apiKey) {
            apiKeyInput.value = apiKey;
            initAI();
        }

        function initAI() {
            try {
                ai = new GoogleGenAI({ apiKey });
                apiStatus.textContent = '‚úÖ API key saved ‚Äî ready to go!';
                apiStatus.className = 'api-status success';
            } catch {
                apiStatus.textContent = '‚ùå Could not initialise with that API key';
                apiStatus.className = 'api-status error';
                ai = null;
            }
            updateAskBtn();
        }

        function updateAskBtn() {
            askBtn.disabled = !(ai && uploadedBase64 && questionInput.value.trim());
        }

        saveApiKeyBtn.addEventListener('click', () => {
            apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                apiStatus.textContent = 'Please paste a valid API key';
                apiStatus.className = 'api-status error';
                return;
            }
            localStorage.setItem('googleAiApiKey', apiKey);
            initAI();
        });

        // Quick question buttons
        quickBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                quickBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                questionInput.value = btn.dataset.question;
                updateAskBtn();
            });
        });

        questionInput.addEventListener('input', updateAskBtn);

        // File handling
        fileInput.addEventListener('change', e => {
            if (e.target.files[0]) handleFile(e.target.files[0]);
        });

        uploadZone.addEventListener('dragover', e => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));

        uploadZone.addEventListener('drop', e => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
        });

        // Clicking the zone (not the button) also opens picker
        uploadZone.addEventListener('click', e => {
            if (e.target === uploadZone) fileInput.click();
        });

        async function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('Please upload an image file (JPG, PNG, WEBP, etc.)');
                return;
            }

            uploadedFile = file;
            uploadedBase64 = await toBase64(file);

            // Show preview inside the upload zone
            const dataUrl = `data:${file.type};base64,${uploadedBase64}`;
            imagePreview.src = dataUrl;
            resultImage.src = dataUrl;

            uploadPrompt.style.display = 'none';
            imagePreviewWrapper.classList.add('visible');
            changeImageBtn.classList.add('visible');
            uploadZone.classList.add('has-image');

            updateAskBtn();
        }

        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Ask Gemini
        askBtn.addEventListener('click', async () => {
            const question = questionInput.value.trim();
            if (!ai || !uploadedBase64 || !question) return;

            askBtn.disabled = true;

            // Show results section
            resultsSection.classList.add('visible');
            answerContent.className = 'answer-content loading';
            answerContent.innerHTML = '<span class="spinner"></span> Gemini is analysing your image‚Ä¶';
            answerMeta.textContent = '';

            const systemContext = `You are a helpful campus navigation assistant for Australian university students.
You have excellent knowledge of university layouts, building naming conventions (e.g. "Building 12", "ENG Block", "H Block"), 
floor plan symbols, and Australian academic terminology such as: timetable, lecture theatre, tutorial room, 
student services, union building, HECS, WAM, semester, faculty, school, and campus.
When answering, be specific and practical. If the image is a timetable, read and interpret it accurately.
If it's a campus map or floor plan, describe spatial relationships clearly.
Always be friendly and encouraging ‚Äî navigating a new campus can be stressful!`;

            try {
                const response = await ai.models.generateContent({
                    model: "gemini-2.5-flash",
                    contents: [
                        {
                            role: "user",
                            parts: [
                                {
                                    inlineData: {
                                        mimeType: uploadedFile.type,
                                        data: uploadedBase64,
                                    }
                                },
                                {
                                    text: systemContext + "\n\nStudent's question: " + question
                                }
                            ]
                        }
                    ]
                });

                const answer = response.text;
                answerContent.className = 'answer-content';
                answerContent.textContent = answer;

                const now = new Date();
                answerMeta.textContent =
                    `Answered at ${now.toLocaleTimeString('en-AU')} ¬∑ ${uploadedFile.name} ¬∑ gemini-2.5-flash`;

            } catch (err) {
                console.error('Gemini error:', err);
                answerContent.className = 'answer-content';
                answerContent.textContent =
                    '‚ùå Something went wrong. Check your API key and try again.\n\n' + (err.message || err);
                answerMeta.textContent = '';
            }

            updateAskBtn();
        });

        updateAskBtn();
    </script>
</body>
</html>
