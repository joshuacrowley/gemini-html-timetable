<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecture Audio Transcriber & Deadline Extractor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            padding: 24px 16px;
            color: #1a1a2e;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #003087 0%, #0057b8 60%, #0077cc 100%);
            color: white;
            padding: 32px 36px;
            border-radius: 16px 16px 0 0;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -40px; right: -40px;
            width: 200px; height: 200px;
            background: rgba(255,255,255,0.05);
            border-radius: 50%;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: -60px; right: 100px;
            width: 280px; height: 280px;
            background: rgba(255,255,255,0.04);
            border-radius: 50%;
        }

        .header-badge {
            display: inline-block;
            background: rgba(255,255,255,0.18);
            border: 1px solid rgba(255,255,255,0.25);
            border-radius: 20px;
            padding: 4px 14px;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .header p {
            opacity: 0.85;
            font-size: 1rem;
            max-width: 560px;
        }

        /* Main card */
        .main-card {
            background: white;
            border-radius: 0 0 16px 16px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        /* API Key */
        .api-key-section {
            padding: 18px 28px;
            background: #f8f9fb;
            border-bottom: 1px solid #e8eaed;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .api-key-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #555;
            white-space: nowrap;
        }

        #apiKeyInput {
            flex: 1;
            min-width: 220px;
            padding: 9px 14px;
            border: 1.5px solid #d0d5dd;
            border-radius: 8px;
            font-size: 0.9rem;
            font-family: monospace;
            transition: border-color 0.2s;
        }

        #apiKeyInput:focus {
            outline: none;
            border-color: #0057b8;
        }

        #saveApiKey {
            padding: 9px 20px;
            background: #0057b8;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            white-space: nowrap;
            transition: background 0.2s;
        }

        #saveApiKey:hover { background: #003087; }

        .api-status {
            font-size: 0.82rem;
            color: #888;
            white-space: nowrap;
        }

        .api-status.ready { color: #1a8a45; font-weight: 500; }
        .api-status.error { color: #c0392b; }

        /* Content layout */
        .content {
            padding: 28px;
        }

        /* Upload area */
        .upload-zone {
            border: 2px dashed #c5ccd6;
            border-radius: 12px;
            padding: 36px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #fafbfc;
            margin-bottom: 20px;
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: #0057b8;
            background: #eef4ff;
        }

        .upload-icon {
            font-size: 2.8rem;
            margin-bottom: 10px;
        }

        .upload-zone h3 {
            font-size: 1.05rem;
            color: #2c3e50;
            margin-bottom: 6px;
        }

        .upload-zone p {
            color: #7a8599;
            font-size: 0.88rem;
            margin-bottom: 14px;
        }

        .upload-zone .formats {
            font-size: 0.78rem;
            color: #a0a8b8;
            margin-top: 10px;
        }

        .btn-browse {
            display: inline-block;
            padding: 10px 24px;
            background: #0057b8;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background 0.2s;
        }

        .btn-browse:hover { background: #003087; }

        input[type="file"] { display: none; }

        /* Audio player */
        .audio-player-wrap {
            display: none;
            background: #f0f4ff;
            border: 1px solid #c8d8f8;
            border-radius: 10px;
            padding: 14px 18px;
            margin-bottom: 20px;
            align-items: center;
            gap: 14px;
        }

        .audio-player-wrap.visible { display: flex; }

        .audio-file-info {
            flex: 1;
            min-width: 0;
        }

        .audio-file-name {
            font-weight: 600;
            color: #1a2d5a;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .audio-file-meta {
            font-size: 0.78rem;
            color: #6b7fa3;
            margin-top: 2px;
        }

        #audioPlayer {
            flex: 2;
            min-width: 200px;
            height: 36px;
            border-radius: 8px;
        }

        .btn-remove {
            background: none;
            border: 1px solid #c5ccd6;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            color: #888;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .btn-remove:hover { background: #fee; border-color: #e74c3c; color: #e74c3c; }

        /* Quick action buttons */
        .actions-label {
            font-size: 0.82rem;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: 10px;
        }

        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 24px;
        }

        .btn-action {
            display: flex;
            align-items: center;
            gap: 7px;
            padding: 10px 16px;
            background: white;
            border: 1.5px solid #d0d5dd;
            border-radius: 9px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: #2c3e50;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-action:hover:not(:disabled) {
            border-color: #0057b8;
            color: #0057b8;
            background: #eef4ff;
        }

        .btn-action:disabled {
            opacity: 0.45;
            cursor: not-allowed;
        }

        .btn-action.active {
            background: #0057b8;
            border-color: #0057b8;
            color: white;
        }

        .btn-action .icon { font-size: 1rem; }

        /* Output layout */
        .output-grid {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 20px;
        }

        /* Main output panel */
        .panel {
            border: 1px solid #e8eaed;
            border-radius: 12px;
            overflow: hidden;
        }

        .panel-header {
            padding: 14px 20px;
            background: #f8f9fb;
            border-bottom: 1px solid #e8eaed;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: #1a1a2e;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-body {
            padding: 20px;
            min-height: 360px;
        }

        .output-text {
            font-family: 'Georgia', 'Times New Roman', serif;
            font-size: 0.93rem;
            line-height: 1.75;
            color: #2c3e50;
            white-space: pre-wrap;
        }

        .placeholder-text {
            color: #aab3c2;
            font-style: italic;
            font-size: 0.9rem;
            text-align: center;
            padding: 60px 20px;
        }

        .placeholder-text .placeholder-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
            display: block;
        }

        /* Loading state */
        .loading-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            gap: 14px;
        }

        .spinner {
            width: 36px; height: 36px;
            border: 3px solid #e8eaed;
            border-top-color: #0057b8;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-msg {
            color: #6b7fa3;
            font-size: 0.88rem;
        }

        /* Copy button */
        .btn-copy {
            background: none;
            border: 1px solid #d0d5dd;
            border-radius: 6px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.78rem;
            color: #666;
            transition: all 0.2s;
        }

        .btn-copy:hover { background: #f0f4ff; border-color: #0057b8; color: #0057b8; }

        /* Deadlines panel */
        .deadlines-panel {
            border: 1px solid #f0c050;
            border-radius: 12px;
            overflow: hidden;
        }

        .deadlines-header {
            padding: 14px 18px;
            background: linear-gradient(135deg, #fff8e1, #fff3c4);
            border-bottom: 1px solid #f0c050;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .deadlines-header-title {
            font-weight: 700;
            font-size: 0.88rem;
            color: #7a4500;
        }

        .deadline-count-badge {
            background: #f0a500;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 0.72rem;
            font-weight: 700;
            margin-left: auto;
        }

        .deadlines-body {
            padding: 16px;
            min-height: 340px;
            background: #fffdf5;
        }

        .deadline-placeholder {
            color: #c8a85c;
            font-size: 0.85rem;
            text-align: center;
            padding: 50px 12px;
        }

        .deadline-placeholder .dl-icon {
            font-size: 2rem;
            display: block;
            margin-bottom: 10px;
        }

        .deadline-card {
            background: white;
            border: 1px solid #f0d080;
            border-left: 4px solid #f0a500;
            border-radius: 8px;
            padding: 12px 14px;
            margin-bottom: 10px;
        }

        .deadline-card.exam {
            border-left-color: #e74c3c;
        }

        .deadline-card.assignment {
            border-left-color: #0057b8;
        }

        .deadline-card.quiz {
            border-left-color: #8e44ad;
        }

        .deadline-type {
            font-size: 0.68rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #f0a500;
            margin-bottom: 4px;
        }

        .deadline-card.exam .deadline-type { color: #e74c3c; }
        .deadline-card.assignment .deadline-type { color: #0057b8; }
        .deadline-card.quiz .deadline-type { color: #8e44ad; }

        .deadline-title {
            font-weight: 600;
            font-size: 0.88rem;
            color: #1a1a2e;
            margin-bottom: 3px;
        }

        .deadline-date {
            font-size: 0.82rem;
            color: #e67e00;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .deadline-card.exam .deadline-date { color: #c0392b; }
        .deadline-card.assignment .deadline-date { color: #0057b8; }

        .deadline-detail {
            font-size: 0.78rem;
            color: #888;
            line-height: 1.45;
        }

        /* Key terms */
        .terms-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .term-chip {
            background: #eef4ff;
            border: 1px solid #c8d8f8;
            border-radius: 20px;
            padding: 5px 13px;
            font-size: 0.82rem;
            color: #0057b8;
            font-weight: 500;
        }

        /* Dot points */
        .dot-list {
            list-style: none;
            padding: 0;
        }

        .dot-list li {
            padding: 8px 0 8px 22px;
            position: relative;
            border-bottom: 1px solid #f0f2f5;
            font-size: 0.9rem;
            line-height: 1.55;
            color: #2c3e50;
        }

        .dot-list li::before {
            content: '‚Ä¢';
            position: absolute;
            left: 4px;
            color: #0057b8;
            font-weight: bold;
        }

        .dot-list li:last-child { border-bottom: none; }

        /* Error state */
        .error-box {
            background: #fff5f5;
            border: 1px solid #fcc;
            border-radius: 8px;
            padding: 16px;
            color: #c0392b;
            font-size: 0.88rem;
        }

        /* Responsive */
        @media (max-width: 800px) {
            .output-grid {
                grid-template-columns: 1fr;
            }

            .header h1 { font-size: 1.5rem; }
            .quick-actions { gap: 8px; }
            .btn-action { font-size: 0.8rem; padding: 9px 13px; }
            .audio-player-wrap { flex-direction: column; align-items: stretch; }
        }

        @media (max-width: 540px) {
            .api-key-section { flex-direction: column; align-items: stretch; }
            #saveApiKey { width: 100%; text-align: center; }
            .content { padding: 18px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-badge">Gemini API ¬∑ Audio Understanding</div>
            <h1>Lecture Audio Transcriber<br>& Deadline Extractor</h1>
            <p>Upload a lecture recording or podcast ‚Äî Gemini will transcribe it, pull out key deadlines, and help you study smarter.</p>
        </div>

        <div class="main-card">
            <div class="api-key-section">
                <span class="api-key-label">Google AI API Key</span>
                <input type="password" id="apiKeyInput" placeholder="AIza‚Ä¶" maxlength="60">
                <button id="saveApiKey">Save Key</button>
                <span class="api-status" id="apiStatus">Enter your API key to get started</span>
            </div>

            <div class="content">
                <!-- Upload zone -->
                <div class="upload-zone" id="uploadZone">
                    <div class="upload-icon">üéß</div>
                    <h3>Drop your lecture recording here</h3>
                    <p>Drag & drop an audio file, or click below to browse</p>
                    <input type="file" id="fileInput" accept="audio/*,.m4a,.mp3,.wav,.ogg,.flac,.aac,.opus">
                    <button class="btn-browse" onclick="document.getElementById('fileInput').click()">Choose Audio File</button>
                    <div class="formats">Supported: MP3, WAV, M4A, AAC, OGG, FLAC, OPUS ‚Äî max 20 MB</div>
                </div>

                <!-- Audio player -->
                <div class="audio-player-wrap" id="audioPlayerWrap">
                    <div class="audio-file-info">
                        <div class="audio-file-name" id="audioFileName">‚Äî</div>
                        <div class="audio-file-meta" id="audioFileMeta">‚Äî</div>
                    </div>
                    <audio id="audioPlayer" controls></audio>
                    <button class="btn-remove" id="removeFile" title="Remove file">‚úï Remove</button>
                </div>

                <!-- Quick actions -->
                <div class="actions-label">Quick Actions</div>
                <div class="quick-actions">
                    <button class="btn-action" data-action="transcribe" disabled>
                        <span class="icon">üìù</span> Transcribe the full lecture
                    </button>
                    <button class="btn-action" data-action="deadlines" disabled>
                        <span class="icon">üìÖ</span> Extract all due dates &amp; deadlines
                    </button>
                    <button class="btn-action" data-action="summary" disabled>
                        <span class="icon">‚ö°</span> Summarise in dot points
                    </button>
                    <button class="btn-action" data-action="terms" disabled>
                        <span class="icon">üîë</span> List key terms &amp; definitions
                    </button>
                    <button class="btn-action" data-action="assignment" disabled>
                        <span class="icon">üìã</span> What did the lecturer say about the assessment?
                    </button>
                </div>

                <!-- Output grid -->
                <div class="output-grid">
                    <!-- Main output panel -->
                    <div class="panel">
                        <div class="panel-header">
                            <div class="panel-title" id="panelTitle">
                                <span>üìÑ</span> Output
                            </div>
                            <button class="btn-copy" id="copyBtn" style="display:none" onclick="copyOutput()">Copy</button>
                        </div>
                        <div class="panel-body" id="mainOutput">
                            <div class="placeholder-text">
                                <span class="placeholder-icon">üéì</span>
                                Upload a lecture recording, then choose an action above.<br>
                                Results will appear here.
                            </div>
                        </div>
                    </div>

                    <!-- Deadlines sidebar -->
                    <div class="deadlines-panel">
                        <div class="deadlines-header">
                            <span>üìÖ</span>
                            <span class="deadlines-header-title">Deadlines &amp; Assessment Dates</span>
                            <span class="deadline-count-badge" id="deadlineCount" style="display:none">0</span>
                        </div>
                        <div class="deadlines-body" id="deadlinesOutput">
                            <div class="deadline-placeholder">
                                <span class="dl-icon">üóìÔ∏è</span>
                                Exam dates, assignment due dates, and submission deadlines will appear here automatically when you run any action.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { GoogleGenAI } from "https://esm.sh/@google/genai@latest";

        let apiKey = localStorage.getItem('geminiApiKey') || '';
        let ai = null;
        let uploadedFile = null;
        let currentOutputText = '';

        const apiKeyInput  = document.getElementById('apiKeyInput');
        const saveApiKeyBtn = document.getElementById('saveApiKey');
        const apiStatus    = document.getElementById('apiStatus');
        const uploadZone   = document.getElementById('uploadZone');
        const fileInput    = document.getElementById('fileInput');
        const audioPlayerWrap = document.getElementById('audioPlayerWrap');
        const audioPlayer  = document.getElementById('audioPlayer');
        const audioFileName = document.getElementById('audioFileName');
        const audioFileMeta = document.getElementById('audioFileMeta');
        const removeFileBtn = document.getElementById('removeFile');
        const actionBtns   = document.querySelectorAll('.btn-action');
        const mainOutput   = document.getElementById('mainOutput');
        const panelTitle   = document.getElementById('panelTitle');
        const copyBtn      = document.getElementById('copyBtn');
        const deadlinesOutput = document.getElementById('deadlinesOutput');
        const deadlineCount = document.getElementById('deadlineCount');

        // ‚îÄ‚îÄ API Key ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        if (apiKey) {
            apiKeyInput.value = apiKey;
            initAI();
        }

        function initAI() {
            try {
                ai = new GoogleGenAI({ apiKey });
                apiStatus.textContent = '‚úÖ API key ready';
                apiStatus.className = 'api-status ready';
                refreshActionButtons();
            } catch {
                apiStatus.textContent = '‚ùå Invalid API key';
                apiStatus.className = 'api-status error';
            }
        }

        saveApiKeyBtn.addEventListener('click', () => {
            apiKey = apiKeyInput.value.trim();
            if (!apiKey) { apiStatus.textContent = 'Please enter a valid key'; return; }
            localStorage.setItem('geminiApiKey', apiKey);
            initAI();
        });

        // ‚îÄ‚îÄ File upload ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        fileInput.addEventListener('change', e => { if (e.target.files[0]) handleFile(e.target.files[0]); });

        uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('dragover'); });
        uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
        uploadZone.addEventListener('drop', e => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
        });

        removeFileBtn.addEventListener('click', () => {
            uploadedFile = null;
            audioPlayer.src = '';
            audioPlayerWrap.classList.remove('visible');
            fileInput.value = '';
            refreshActionButtons();
            resetOutput();
        });

        function handleFile(file) {
            const MAX_MB = 20;
            if (file.size > MAX_MB * 1024 * 1024) {
                showError(`File is ${(file.size / 1024 / 1024).toFixed(1)} MB ‚Äî please use a file under ${MAX_MB} MB for inline processing.`);
                return;
            }

            if (!file.type.startsWith('audio/') && !['m4a','mp3','wav','ogg','flac','aac','opus'].some(ext => file.name.toLowerCase().endsWith(ext))) {
                showError('Please upload an audio file (MP3, WAV, M4A, AAC, OGG, FLAC, OPUS).');
                return;
            }

            uploadedFile = file;

            const url = URL.createObjectURL(file);
            audioPlayer.src = url;
            audioFileName.textContent = file.name;
            audioFileMeta.textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB ¬∑ ${normaliseMime(file) || file.type}`;
            audioPlayerWrap.classList.add('visible');

            refreshActionButtons();
            resetOutput();
        }

        function normaliseMime(file) {
            const t = file.type;
            const name = file.name.toLowerCase();
            if (t === 'audio/mpeg' || name.endsWith('.mp3')) return 'audio/mp3';
            if (t === 'audio/mp4' || name.endsWith('.m4a'))  return 'audio/mp4';
            if (t === 'audio/wav' || name.endsWith('.wav'))  return 'audio/wav';
            if (t === 'audio/ogg' || name.endsWith('.ogg'))  return 'audio/ogg';
            if (t === 'audio/flac' || name.endsWith('.flac')) return 'audio/flac';
            if (t === 'audio/aac' || name.endsWith('.aac'))  return 'audio/aac';
            if (t === 'audio/opus' || name.endsWith('.opus')) return 'audio/opus';
            if (t === 'audio/webm' || name.endsWith('.webm')) return 'audio/webm';
            return t || 'audio/mp3';
        }

        function refreshActionButtons() {
            const ready = !!(ai && uploadedFile);
            actionBtns.forEach(btn => btn.disabled = !ready);
        }

        function resetOutput() {
            currentOutputText = '';
            copyBtn.style.display = 'none';
            panelTitle.innerHTML = '<span>üìÑ</span> Output';
            mainOutput.innerHTML = `<div class="placeholder-text">
                <span class="placeholder-icon">üéì</span>
                Upload a lecture recording, then choose an action above.<br>Results will appear here.
            </div>`;
            deadlinesOutput.innerHTML = `<div class="deadline-placeholder">
                <span class="dl-icon">üóìÔ∏è</span>
                Exam dates, assignment due dates, and submission deadlines will appear here automatically when you run any action.
            </div>`;
            deadlineCount.style.display = 'none';
        }

        // ‚îÄ‚îÄ Action buttons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        actionBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                if (btn.disabled) return;
                runAction(btn.dataset.action, btn);
            });
        });

        async function runAction(action, btn) {
            actionBtns.forEach(b => { b.disabled = true; b.classList.remove('active'); });
            btn.classList.add('active');
            copyBtn.style.display = 'none';

            const prompts = {
                transcribe: {
                    icon: 'üìù',
                    label: 'Full Lecture Transcript',
                    msg: 'Transcribing lecture‚Ä¶',
                    prompt: `Please transcribe this lecture audio in full. 
Use Australian English spelling and terminology (e.g. "practicals", "tutorials", "unit", "subject", "semester", "HECS"). 
Format with clear paragraph breaks between distinct topics. 
If the audio is unclear at any point write [inaudible]. 
Do not add commentary ‚Äî just provide the verbatim transcript.`
                },
                deadlines: {
                    icon: 'üìÖ',
                    label: 'Deadlines & Due Dates',
                    msg: 'Extracting deadlines‚Ä¶',
                    prompt: `Listen carefully to this lecture audio and extract EVERY deadline, due date, exam date, and time-sensitive requirement mentioned.
For each item, note:
- What it is (assignment, exam, quiz, tutorial submission, etc.)
- The exact date or week mentioned
- Any submission method, word count, or specific instructions
- Which unit/subject it relates to if mentioned

Format as a clear list. Use Australian university terminology (assessment, submission, tutorial, practical, trimester/semester). 
If no specific deadlines are mentioned, say so clearly.`
                },
                summary: {
                    icon: '‚ö°',
                    label: 'Dot-Point Summary',
                    msg: 'Summarising lecture‚Ä¶',
                    prompt: `Summarise this lecture in concise dot points for an Australian university student studying for exams.
Structure your response as:
**Main Topic:**
[one sentence]

**Key Points:**
‚Ä¢ [dot point]
‚Ä¢ [dot point]
...

**Important Concepts Introduced:**
‚Ä¢ ...

**Any Mentioned Requirements or Assessments:**
‚Ä¢ ...

Use plain language. Focus on what a student needs to know for assessments. Maximum 20 dot points total.`
                },
                terms: {
                    icon: 'üîë',
                    label: 'Key Terms & Definitions',
                    msg: 'Extracting key terms‚Ä¶',
                    prompt: `Listen to this lecture audio and extract all key terms, concepts, definitions, and technical vocabulary introduced or explained.
For each term:
- State the term
- Provide the definition or explanation as given in the lecture
- Note any examples provided

Format clearly as a glossary. Focus on terms a student would need to understand for exams and assessments in an Australian university context.`
                },
                assignment: {
                    icon: 'üìã',
                    label: 'Assessment Details',
                    msg: 'Extracting assessment info‚Ä¶',
                    prompt: `Listen to this lecture audio and extract everything the lecturer said about assignments, assessments, essays, reports, presentations, group work, or any other assessment tasks.
Include:
- Assessment name and type
- Word count or length requirements
- Due dates or submission weeks
- Submission method (Turnitin, LMS, in-person, etc.)
- Marking criteria or weighting if mentioned
- Group vs individual work
- Any specific formatting or referencing style required
- Any tips or guidance the lecturer gave about the assessment

Use Australian university terminology throughout. If no assessment details were mentioned, say so clearly.`
                }
            };

            const config = prompts[action];
            panelTitle.innerHTML = `<span>${config.icon}</span> ${config.label}`;
            showLoading(config.msg);

            try {
                const base64data = await fileToBase64(uploadedFile);
                const mimeType = normaliseMime(uploadedFile);

                const response = await ai.models.generateContent({
                    model: 'gemini-2.5-flash',
                    contents: [
                        {
                            role: 'user',
                            parts: [
                                { text: config.prompt },
                                {
                                    inlineData: {
                                        mimeType: mimeType,
                                        data: base64data,
                                    }
                                }
                            ]
                        }
                    ]
                });

                const text = response.text;
                currentOutputText = text;
                renderMainOutput(action, text);
                copyBtn.style.display = 'inline-block';

                // Always try to extract deadlines in parallel (only if not already doing deadlines)
                if (action !== 'deadlines') {
                    extractDeadlines(base64data, mimeType, text);
                } else {
                    renderDeadlinesFromText(text);
                }

            } catch (err) {
                console.error(err);
                showError(err.message || 'Something went wrong. Check your API key and try again.');
            }

            actionBtns.forEach(b => b.disabled = false);
            refreshActionButtons();
            btn.classList.remove('active');
        }

        function renderMainOutput(action, text) {
            if (action === 'transcribe') {
                mainOutput.innerHTML = `<div class="output-text">${escHtml(text)}</div>`;
            } else if (action === 'summary') {
                // Render markdown-ish dot points
                const html = text
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    .replace(/^‚Ä¢ (.+)$/gm, '<li>$1</li>')
                    .replace(/(<li>.*<\/li>)+/gs, match => `<ul class="dot-list">${match}</ul>`)
                    .replace(/\n{2,}/g, '</p><p>')
                    .replace(/^(.+)$/gm, (line) => line.startsWith('<') ? line : `<p>${line}</p>`);
                mainOutput.innerHTML = `<div class="output-text" style="font-family: inherit">${html}</div>`;
            } else if (action === 'terms') {
                // Render as readable list
                mainOutput.innerHTML = `<div class="output-text" style="font-family: inherit">${
                    text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\n/g, '<br>')
                }</div>`;
            } else {
                mainOutput.innerHTML = `<div class="output-text" style="font-family: inherit">${
                    text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\n/g, '<br>')
                }</div>`;
            }
        }

        async function extractDeadlines(base64data, mimeType, transcript) {
            try {
                const prompt = `Based on this lecture audio transcript, extract all deadlines, due dates, exam dates, assessment tasks, and submission requirements mentioned.

Transcript:
${transcript}

Return a JSON array. Each item must have:
- "type": one of "assignment", "exam", "quiz", "presentation", "lab", "other"
- "title": short name of the task
- "date": the date or week mentioned (e.g. "Week 8", "15 March", "end of semester")
- "detail": brief extra detail (word count, submission method, weighting, etc.)

If no deadlines are mentioned, return an empty array [].
Return ONLY valid JSON, no markdown fences.`;

                const resp = await ai.models.generateContent({
                    model: 'gemini-2.5-flash',
                    contents: [{ role: 'user', parts: [{ text: prompt }] }],
                    config: { responseMimeType: 'application/json' }
                });

                let raw = resp.text.trim();
                if (raw.startsWith('```')) {
                    raw = raw.replace(/^```[a-z]*\n?/, '').replace(/\n?```$/, '');
                }
                const items = JSON.parse(raw);
                renderDeadlineCards(items);
            } catch {
                // Silent ‚Äî deadlines panel stays as-is or shows placeholder
            }
        }

        function renderDeadlinesFromText(text) {
            // When the "deadlines" action is run, try to parse structured data from the text response
            // Fallback: display as formatted text in the deadlines panel
            deadlinesOutput.innerHTML = `<div class="output-text" style="font-size:0.85rem; font-family:inherit; padding:4px 0">` +
                text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>') +
                `</div>`;
            deadlineCount.style.display = 'none';

            // Also try JSON extraction
            extractDeadlines('', '', text);
        }

        function renderDeadlineCards(items) {
            if (!items || items.length === 0) {
                deadlinesOutput.innerHTML = `<div class="deadline-placeholder">
                    <span class="dl-icon">‚úÖ</span>
                    No specific deadlines or assessment dates were mentioned in this recording.
                </div>`;
                deadlineCount.style.display = 'none';
                return;
            }

            deadlineCount.textContent = items.length;
            deadlineCount.style.display = 'inline-block';

            deadlinesOutput.innerHTML = items.map(item => {
                const typeClass = ['exam','assignment','quiz','presentation'].includes(item.type) ? item.type : '';
                return `<div class="deadline-card ${typeClass}">
                    <div class="deadline-type">${item.type || 'Deadline'}</div>
                    <div class="deadline-title">${escHtml(item.title || '‚Äî')}</div>
                    <div class="deadline-date">üìÖ ${escHtml(item.date || 'Date TBC')}</div>
                    ${item.detail ? `<div class="deadline-detail">${escHtml(item.detail)}</div>` : ''}
                </div>`;
            }).join('');
        }

        // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function showLoading(msg) {
            mainOutput.innerHTML = `<div class="loading-wrap">
                <div class="spinner"></div>
                <div class="loading-msg">${msg}</div>
            </div>`;
        }

        function showError(msg) {
            mainOutput.innerHTML = `<div class="error-box">‚ùå ${escHtml(msg)}</div>`;
            panelTitle.innerHTML = '<span>‚ö†Ô∏è</span> Error';
        }

        function escHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;');
        }

        window.copyOutput = function () {
            if (!currentOutputText) return;
            navigator.clipboard.writeText(currentOutputText).then(() => {
                copyBtn.textContent = 'Copied!';
                setTimeout(() => { copyBtn.textContent = 'Copy'; }, 1800);
            });
        };
    </script>
</body>
</html>
